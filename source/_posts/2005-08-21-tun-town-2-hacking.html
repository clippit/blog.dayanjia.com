---
layout: post
title: ! '[原]《阿猫阿狗2》游戏拆解'
categories:
- 雕虫小技
tags:
- 教程
- 游戏
published: true
comments: true
---
<p><span style="LINE-HEIGHT: 150%"><p>呵呵~~~“游戏拆解”这是我发明出来的词组<br />是什么意思呢？就是挖出游戏程序里的资源！<br />像一般的程序，要提取资源，用个eXeScope或者Resource Hacker之类的工具就可以了，因为他们都是<b>标准资源</b> ，游戏却不同了，开发者想怎么搞资源就可以怎么搞资源，所以每个游戏的资源都不尽相同，但都是标标准准的<b>非标准资源</b> ，因此每个游戏的拆解都是不同di~~~~<br /><br />本次拆解的对象是软星制作的游戏《阿猫阿狗2》<br />为什么说这是不完全版呢？因为还有很多东东我也没搞懂啊！（找打）<br />俗话说得好，如果你研究过暴雪的游戏，就会发现很多的.mpq文件（这是俗话？？）<br />软星和暴雪一样，也自己研究出了一种文件格式——那就是————.cpk文件<br />实际上，上面的两种文件类型都是把N多N多的文件打包成了一个文件，所以这些文件的容量一般都是上百MB<br /><br />本次拆解的目的有以下几个：<br />1、为玩过《阿猫阿狗2》但是原画/动画/音乐没有全部买到但是又非常想看的同志们服务<br />2、为所有还没有开始玩《阿猫阿狗2》但是好奇心强烈的同志们服务<br />3、为喜欢研究游戏源代码的同志们服务<br />总而言之言而总之，本次拆解的目的就是5个字：为人民服务！<br /><br /><br /><font size="4"><b>以上废话，以下正题：</b></font> <br /><br /><br />
<p><blink>准备软件：</blink>
<p><br />WinRAR：大家都有，下载地址自己去找，用于解开安装光盘上的.cab文件<br />CPK文件提取器：用于解开软星专用的.cpk文件，下载地址：<a href="http://vip.sina.com.cn/cgi-bin/mydocument/share_down.cgi/C40Zi_kYccfOyJfOjKfLc3fLnLfP-Nvo-HrOr-tBXDqoT/:^^UEFM:/^^bl7h_W2tblFx/robin.rar">点击此</a><br />Binkplay 80 RC1：《阿猫阿狗2》中的动画是特殊的.bik格式，需要用专门的播放器播放，下载地址：<a href="http://www.onlinedown.net/soft/11654.htm" target="_blank">点击此</a><br /><br /><br /><font size="3">重要文件存放地址：</font><br /><br />binkdata0.cpk<br />[游戏目录]\data\<br />[光盘CD3]\data4.cab 压缩包中<br /><br />binkdata1.cpk<br />[游戏目录]\data\<br />[光盘CD4]\Tuntown2\Data\<br /><br />basedata.cpk<br />[游戏目录]\data\<br />[光盘CD1]\data1.cab 压缩包中<br /><br /><b>把这三个文件用CPK文件提取器分别提取</b><br /><br />binkdata0.cpk和binkdata1.cpk提取完毕后都是.bik文件，就是游戏里的所有动画<br /><br />binkdata0.cpk中有三个文件：CD2.bik是片头动画、END.bik是片尾字幕动画、LOGO.bik是主界面的背景动画<br /><br />binkdata1.cpk中共有27个文件，他们都是游戏中的过场动画，这些文件名都比较乱，他们分别所对应的过场动画的名称如下请往下看<br /><br />basedata.cpk里散落着许多.dds文件，他们都是贴图文件，虽然他们都像拼图一样的图片，但是经过处理后他们就能变成游戏中的3D人物。此外，游戏中的“原画”也在这里，还有游戏地图等其他图片，大家可以用ACDSee或者IrfanView进行浏览<br /><br />附：所有动画的文件名和标题一览表：<br />（按游戏出场顺序排列）<br /><br /></p>
<table>
<tbody>
<tr>
<td width="68">
<div align="center">CD2.bik</div></td>
<td width="85">
<div align="center">片头动画</div></td></tr>
<tr>
<td>
<div align="center">1A.bik</div></td>
<td>
<div align="center">小镇之梦</div></td></tr>
<tr>
<td>
<div align="center">1C.bik</div></td>
<td>
<div align="center">可爱的鬼屋</div></td></tr>
<tr>
<td>
<div align="center">1I.bik</div></td>
<td>
<div align="center">冒领追辑令</div></td></tr>
<tr>
<td>
<div align="center">2B.bik</div></td>
<td>
<div align="center">我是饭桶王</div></td></tr>
<tr>
<td>
<div align="center">3I.bik</div></td>
<td>
<div align="center">鬼屋魔影</div></td></tr>
<tr>
<td>
<div align="center">1DD.bik</div></td>
<td>
<div align="center">日间过场一</div></td></tr>
<tr>
<td>
<div align="center">4D.bik</div></td>
<td>
<div align="center">毁灭性武器</div></td></tr>
<tr>
<td>
<div align="center">5A.bik</div></td>
<td>
<div align="center">广场大决战</div></td></tr>
<tr>
<td>
<div align="center">5G.bik</div></td>
<td>
<div align="center">&nbsp; 中毒？！</div></td></tr>
<tr>
<td>
<div align="center">5I.bik</div></td>
<td>
<div align="center">小队突围战</div></td></tr>
<tr>
<td>
<div align="center">5Q.bik</div></td>
<td>
<div align="center">不要吃我！</div></td></tr>
<tr>
<td>
<div align="center">6B.bik</div></td>
<td>
<div align="center">先下手为强</div></td></tr>
<tr>
<td>
<div align="center">6G.bik</div></td>
<td>
<div align="center">木桶镇号外</div></td></tr>
<tr>
<td>
<div align="center">2DD.bik</div></td>
<td>
<div align="center">日间过场二</div></td></tr>
<tr>
<td>
<div align="center">7Q.bik</div></td>
<td>
<div align="center">大麦不会错</div></td></tr>
<tr>
<td>
<div align="center">3DD.bik</div></td>
<td>
<div align="center">日间过场三</div></td></tr>
<tr>
<td>
<div align="center">4DD.bik</div></td>
<td>
<div align="center">日间过场四</div></td></tr>
<tr>
<td>
<div align="center">12C.bik</div></td>
<td>
<div align="center">潜入，小心</div></td></tr>
<tr>
<td>
<div align="center">12F.bik</div></td>
<td>
<div align="center">大麦受难日</div></td></tr>
<tr>
<td>
<div align="center">13A.bik</div></td>
<td>
<div align="center">大海漂流记</div></td></tr>
<tr>
<td>
<div align="center">13R.bik</div></td>
<td>
<div align="center">正义制裁拳</div></td></tr>
<tr>
<td>
<div align="center">14D.bik</div></td>
<td>
<div align="center">可恶的艾伦</div></td></tr>
<tr>
<td>
<div align="center">14I.bik</div></td>
<td>
<div align="center">阿康惹的祸</div></td></tr>
<tr>
<td>
<div align="center">14J.bik</div></td>
<td>
<div align="center">我们回家了</div></td></tr>
<tr>
<td>
<div align="center">14P.bik</div></td>
<td>
<div align="center">告诉全世界</div></td></tr>
<tr>
<td>
<div align="center">5DD.bik</div></td>
<td>
<div align="center">日间过场五</div></td></tr>
<tr>
<td>
<div align="center">15E.bik</div></td>
<td>
<div align="center">结局动画</div></td></tr>
<tr>
<td>
<div align="center">end.bik</div></td>
<td>
<div align="center">制作人员</div></td></tr></tbody></table>
<p><br />另外，游戏中的所有背景音乐和音效的位置是：<br />[游戏目录]\data\music\<br />[游戏目录]\data\sound\<br />[光盘CD3]\data3.cab 压缩包中<br /><br />光盘中的cab压缩包里还有很多CPK文件，但是他们相对来说文件都比较小，如果大家有兴趣可以全部解开看看<br /><br /><br />好了~~~今天就写到这里<br />今后有补充我会添加的<br />欢迎大家提出意见和建议<br /><br />最后我把“CPK文件格式分析及完美提取器”作者的帖子放到这里，对CPK文件的文件格式有兴趣的朋友可以看一看：（作者最初编写此软件的目的是解开仙剑三的CPK文件，但是他同样可以用在猫狗2上）<br /><br /><br /></p>
<p>引用：<br /></p>
<blockquote>
<p>
</p><hr /></blockquote></p>

<p><p></p>
<blockquote dir="ltr" style="MARGIN-RIGHT: 0px">
<p>经过2天的努力，总算写成了这个CPK提取器！经测试，它在仙剑3中工作得很好，我估计在外传中使用问题也不大，因为毕竟游戏引擎没有太大的变化。<br /><br />.CPK应该是是软星自己写的文件格式，不过我在网上查找相关资料时意外的发现了一个叫风魂的游戏，我估计软星的程序员一定研究过这个游戏，因为两者的数据存储方式惊人地相同，软星只改变了一些小地方（如文件头部）。两者同样采用MiniLZO快速压缩算法，采用排过序的CRC作为ID以方便使用二分搜索来快速定位文件等等，下面我就来简单介绍一下，其实我对文件的分析很不完全，好多地方我并不清楚，不过这些初步成果已经足够写一个CPK提取器了。<br /><br />CPK文件格式简介<br />文件头0x80字节为CPK的基本信息，其中头4字节为CPK文件标志：0x52 0x53 0x 54 0x1A，从0x80开始是一个类似于硬盘FAT的结构，由若干个 struct构成（我称之为索引，下面会详细讨论）最后才是数据区，CPK中存储的所有的文件都经过MiniLZO压缩。<br /><br />索引结构：<br />Type <br />Index=record<br />CRC :DWORD;<br />Attrib :DWORD;<br />ParentDir :DWORD;<br />Offset :DWORD;<br />CompressedSize :DWORD;<br />OriginalSize :DWORD;<br />InfoRecordSize :DWORD;(???????????)<br />每个Index代表一个文件（目录也是一种文件），占0x1C个字节，从CPK的0x80开始紧密排列。Index结构的总数存储在CPK的0x20处，是一个DWORD<br />下面我来一一做出解释：<br />CRC：据我猜测应该是根据文件名Hash出的一个数值，若干个Index结构在CPK文件中就是按这个数值升序排列的。这样的好处是只要计算出要访问文件的CRC，就可以利用二分查找在对数时间内定位该文件的Index，进而读取数据。<br />Attrib：该文件的属性，我只知道00000003代表目录，其他的都不太清楚，不过这已经足够了。<br />ParentDir：一个CRC值，等于它的父目录的CRC。CPK文件支持子目录，当你定位好一个文件的index后，通过这个指针反复向上层遍历，就可以取得它的完整的存储路径。在根目录下的文件的Index中此值为0。<br />Offset：压缩后的数据在CPK中的偏移量。<br />CompressedSize：压缩后数据的大小。对于目录，这个值为0。<br />OriginalSize：原始文件的大小，方便你解压时开缓冲区。<br />InfoRecordSize：奇怪的参数。对于每一个Index所代表的文件，压缩后的数据在CPK中从index.Offset起开始存储，占用index.CompressedSize的空间，接下来就是一个大小为InfoRecordSize的奇怪记录，我只知道这个记录的一开头就是文件名，以#0结束，其他的都不清楚，有兴趣的可以研究一下。<br />需要注意的是，只要InfoRecordSize为0，或这个Index不是目录，但CompressedSize为0，这个Index就毫无疑义，不需处理。我因为多次运行升级程序（为了调试它来研究CPK格式），文件中已有好多这样的无效Index了。<br />MiniLZO解压：<br />我不想研究这种东西了，让GbEngine.dll自己做去吧。看看他的ExportTable，发现有这么一行：<br />?DeCompress@CPK@@QAEKPAX0K@Z<br />翻译过来就是<br />public: unsigned long __thiscall CPK::DeCompress(void *,void *,unsigned long)<br />实际上是<br />function DeCompress(Dest,Source:pointer;SourceSize:integer):integer;stdcall;<br />这下就大功告成了。<br /><br />2004年8月22日<br />苏州中学　徐汝斌</p>
<p>
</p><hr />
<br /><br />
<p></p></blockquote></p></p></span></p>
