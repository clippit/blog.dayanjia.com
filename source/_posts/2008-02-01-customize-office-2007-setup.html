---
layout: post
title: 自定义 Office 2007 安装程序
categories:
- 雕虫小技
tags:
- Microsoft
- Office
- 教程
published: true
comments: true
---
<p><span style="LINE-HEIGHT: 150%"><p>今天花一点时间讲一讲自定义Office 2007的安装程序，虽然时效性已经不是很强了哈！</p>
<p>首先告诉大家一个命令行参数，在命令提示符下进入Office 2007的安装程序所在的目录，比如我用的是虚拟光驱H:，那就是输入“H:”就可以了。然后输入“setup /admin”，就可以开启官方的自定义工具。但是我却不推荐大家直接使用它，因为这个工具主要是为了给企业大规模部署的时候用的，个人用户如果想做一些简单自动化的工作完全没有必要用它。当然，它的功能十分强大，做一些高级的功能还是很有用的。</p>
<p>其实所谓的自定义，无非就是一些自动化的工作。我们在这里以Enterprise版的Office 2007为例简单说一说。如果你的安装程序是放在光盘里面，或者是个镜像文件，当然要先把他们全部复制到硬盘里面，比如E:\OFFICE\。进入安装程序所在的目录，找到一个叫做“Enterprise.WW”的文件夹，里面有一个config.xml文件，用编辑器打开它。事实上我们所要做的大部分工作就是修改这个文件。</p>
<p>当前状态下，config文件并没有包含实质性的内容，虽然你可以看到很多字符，但是都是被注释掉的，但是它们可以作为你的模板。</p>
<blockquote>
<p><font face="Courier New, Courier, monospace" color="#0000ff">&lt;Configuration Product=</font><font face="Courier New, Courier, monospace" color="#ff00ff">"Enterprise"</font><font face="Courier New, Courier, monospace"><font color="#0000ff">&gt;</font></font></p>
<p><font face="Courier New, Courier, monospace" color="#008000">　　　&lt;!-- &lt;Display Level="full" CompletionNotice="yes" SuppressModal="no" AcceptEula="no" /&gt; --&gt;<br /><br />　　　&lt;!-- &lt;Logging Type="standard" Path="%temp%" Template="Microsoft Office Enterprise Setup(*).txt" /&gt; --&gt;<br /><br />　　　&lt;!-- &lt;PIDKEY Value="BCDFGHJKMPQRTVWXY2346789B" /&gt; --&gt;</font></p>
<p><font face="Courier New, Courier, monospace" color="#008000">　　　&lt;!-- &lt;USERNAME Value="Customer" /&gt; --&gt;<br /><br />　　　&lt;!-- &lt;COMPANYNAME Value="MyCompany" /&gt; --&gt;<br /><br />　　　&lt;!-- &lt;INSTALLLOCATION Value="%programfiles%\Microsoft Office" /&gt; --&gt;<br /><br />　　　&lt;!-- &lt;LIS CACHEACTION="CacheOnly" /&gt; --&gt;<br /><br />　　　&lt;!-- &lt;SOURCELIST Value="\\server1\share\Office12;\\server2\share\Office12" /&gt; --&gt;<br /><br />　　　&lt;!-- &lt;DistributionPoint Location="\\server\share\Office12" /&gt; --&gt;<br /><br />　　　&lt;!-- &lt;OptionState Id="OptionID" State="absent" Children="force" /&gt; --&gt;<br /><br />　　　&lt;!-- &lt;Setting Id="Reboot" Value="IfNeeded" /&gt; --&gt;<br /><br />　　　&lt;!-- &lt;Command Path="msiexec.exe" Args="/i \\server\share\my.msi" QuietArg="/q" ChainPosition="after" Execute="install" /&gt; --&gt;</font></p>
<p><font face="Courier New, Courier, monospace" color="#0000ff">&lt;/Configuration&gt;</font><font face="Courier New, Courier, monospace"><br /></font></p></blockquote>
<p><strong><font size="3">下面我把我修改了以后的文件发上来：</font></strong></p>
<blockquote>
<p><font face="Courier New, Courier, monospace" color="#0000ff">&lt;Configuration Product=</font><font face="Courier New, Courier, monospace" color="#ff00ff">"Enterprise"</font><font face="Courier New, Courier, monospace"><font color="#0000ff">&gt;</font></font></p>
<p><font face="Courier New, Courier, monospace">　　　<font color="#0000ff">&lt;Display Level=</font><font color="#ff00ff">"full"</font><font color="#0000ff"> CompletionNotice=</font><font color="#ff00ff">"yes"</font> <font color="#0000ff">SuppressModal=</font><font color="#ff00ff">"no"</font><font color="#0000ff"> AcceptEula=</font><font color="#ff00ff">"yes"</font><font color="#0000ff"> /&gt;</font><br /><br /><font color="#008000">　　　&lt;!-- &lt;Logging Type="standard" Path="%temp%" Template="Microsoft Office Enterprise Setup(*).txt" /&gt; --&gt;</font><br /><br />　　<font color="#0000ff">　&lt;PIDKEY Value=</font><font color="#ff00ff">"CTVX96394RT2D3QMTR3X8BDQ8"</font><font color="#0000ff"> /&gt;</font></font></p>
<p><font face="Courier New, Courier, monospace">　　　<font color="#0000ff">&lt;USERNAME Value=</font><font color="#ff00ff">"Clippit"</font><font color="#0000ff"> /&gt;</font><br /><br /><font color="#0000ff">　　　&lt;COMPANYNAME Value=</font><font color="#ff00ff">"Clippit Studio"</font><font color="#0000ff"> /&gt;</font><br /><br /><font color="#008000">　　　&lt;!-- &lt;INSTALLLOCATION Value="%programfiles%\Microsoft Office" /&gt; --&gt;</font><br /><br /><font color="#0000ff">　　　&lt;LIS CACHEACTION=</font><font color="#ff00ff">"RemoveCacheOnly"</font><font color="#0000ff"> /&gt;</font><br /><br /><font color="#008000">　　　&lt;!-- &lt;SOURCELIST Value="\\server1\share\Office12;\\server2\share\Office12" /&gt; --&gt;</font><br /><br /><font color="#008000">　　　&lt;!-- &lt;DistributionPoint Location="\\server\share\Office12" /&gt; --&gt;</font><br /><br /><font color="#008000">　　　&lt;!-- &lt;OptionState Id="OptionID" State="absent" Children="force" /&gt; --&gt;</font><br /><br /><font color="#008000">　　　&lt;!-- &lt;Setting Id="Reboot" Value="IfNeeded" /&gt; --&gt;</font><br /><br /><font color="#008000">　　　&lt;!-- &lt;Command Path="msiexec.exe" Args="/i \\server\share\my.msi" QuietArg="/q" ChainPosition="after" Execute="install" /&gt; --&gt;</font></font></p>
<p><font face="Courier New, Courier, monospace" color="#0000ff">&lt;/Configuration&gt;</font><font face="Courier New, Courier, monospace"><br /></font></p></blockquote>
<p>可以看到，我修改了几个小地方，下面一一说明：</p>
<p>▲　首先，如果你需要做这些自定义的话，就必须把注释的标记去掉，在这里，就是“<font face="Courier New" color="#008000">&lt;!-- </font>”和“<font face="Courier New" color="#008000"> --&gt;</font>”，去掉之后它们才能真正有效。 </p>
<p>▲　然后来看“<font face="Courier New"><font color="#0000ff">AcceptEula=</font><font color="#ff00ff">"yes"</font></font>”，这个很简单，把原来的no改成了yes，这样安装的时候就自动同意许可文件了。 </p>
<p>▲　“<font face="Courier New"><font color="#0000ff">&lt;PIDKEY Value=</font><font color="#ff00ff">"CTVX96394RT2D3QMTR3X8BDQ8"</font><font color="#0000ff"> /&gt;</font></font>”这一行，就是序列号了，把自己的序列号替换掉原来的“<font face="Courier New" color="#008000">BCDFGHJKMPQRTVWXY2346789B</font>”（其实就是个模板，告诉你有25个字符，不用加“-”）。这里的这个序列号是我用Keygen算的。我之所以选择Enterprise就是因为它安装之后不需要激活可以使用了。 </p>
<p>▲　“<font face="Courier New"><font color="#0000ff">&lt;USERNAME Value=</font><font color="#ff00ff">"Clippit"</font><font color="#0000ff"> /&gt;</font></font>”这一行，输入的是你的用户名，安装完成后会出现在关于对话框中。<font color="#ff0000"><strong>注意！！这里千万不能填写中文！否则安装程序会初始化错误！！</strong></font> </p>
<p>▲　“<font face="Courier New"><font color="#0000ff">&lt;COMPANYNAME Value=</font><font color="#ff00ff">"Clippit Studio"</font><font color="#0000ff"> /&gt;</font></font>”，这里填写的是公司名，<font color="#ff0000">一样不能填写中文，否则也会初始化错误的。</font> </p>
<p>▲　“<font face="Courier New"><font color="#0000ff">&lt;LIS CACHEACTION=</font><font color="#ff00ff">"RemoveCacheOnly"</font><font color="#0000ff"> /&gt;</font></font>”这一行，我需要多说几句。这个选项是设置本地安装源（Local Installation Source，LIS）的。本地安装源这个功能大概是在Office 2003中才有的，当时在安装完Office后，你可以选择是保留它还是删除它。保留本地安装源的话，在以后安装某些Office功能、安装更新等等的时候，就不需要访问原始安装源了；但是本地安装源会占用部分磁盘空间。到了Office 2007，本地安装源的功能还是大同小异，不同的是，安装程序并不提供删除本地安装源的选项。事实上，在Office 2007中，本地安装源被设置为不允许随意删除，哪怕是在系统的磁盘清理工具中也看不到它的身影。如果你安装完了Office 2007，你会看到在C盘下（也有可能是其它盘）看到一个名叫MSOCache的隐藏文件夹，占用了700多MB的空间。<strong>网上很多的文章都说，把这一行改成像我那样就可以不产生本地安装源了。事实上，大错特错！</strong><font face="Courier New" color="#0000ff">CACHEACTION</font>这个参数可以设置成两个值，分别是<font face="Courier New" color="#ff00ff">CacheOnly</font>和<font face="Courier New" color="#ff00ff">RemoveCacheOnly</font>。如果设置成<font face="Courier New" color="#ff00ff">CacheOnly</font>，那么安装程序就会只复制本地安装源到用户的计算机而不安装Office软件；如果设置为<font face="Courier New" color="#ff00ff">RemoveCacheOnly</font>，那么安装程序就会删除复制到用户计算机上的本地安装源，但是前提是Office软件没有被安装。这个功能看似没有作用，其实在大规模部署的时候用处还是很大的，管理员可以先把安装程序统一向用户的计算机上做本地安装源，然后再从本地安装源上进行安装，可以节省不少时间和精力。因此，这个选项对于安装Office 2007来说，是没有任何作用的。不管怎么样，安装程序都会生成本地安装源。当然，如果你不打算以后再安装各种功能和更新，并且的原始安装源（比如光盘）都可以保存地很好的话，你就可以手动把生成的MSOCache隐藏文件夹删掉。 </p>
<p><strong>弄好config.xml文件以后，就可以保存了，下面我来简单地说一下如何把最近发布的Office 2007 SP1集成到安装程序中。</strong></p>
<p>细心的朋友可能会发现在安装程序中有一个Updates文件夹，打开这个文件夹，里面有一个readme.txt文件，这个文件里面只有一句话：“Any patches placed in this folder will be applied during initial install.”翻译过来就是：任何放在这个文件夹下的补丁都会在最初安装时被应用。也就是说，如果我们把SP1的补丁放到这个里面来，在安装的时候就会自动打上补丁了。但是我们下载回来的SP1补丁是一个exe文件，是不符合要求的，所以我们还需要做一些工作。</p>
<p>用命令提示符转到我们下载了SP1补丁的文件夹，在本例中为E:\Downloads\，然后输入下面的命令：<strong><font color="#3333ff">office2007sp1-kb936982-fullfile-zh-cn.exe /extract:E:\OFFICE\Updates\</font></strong>。其中<strong><font color="#3333ff">office2007sp1-kb936982-fullfile-zh-cn.exe</font></strong>便是我们下载回来的SP1补丁，而<strong><font color="#3333ff">E:\OFFICE\</font></strong>就是我们的安装程序所在的文件夹。回车以后，接受许可协议，然后便开始解开文件了。解开后我们可以到updates文件夹下看一看，有好几个.msp文件，这就是使用了Windows Installer技术的补丁文件。这样以来，以后在安装Office的时候，就可以自动打上SP1补丁了。</p>
<p>最后，还有一些高级的应用，比如自动安装上某些ADD-IN，还有自己定制要安装的组件，这些就需要用到官方的自定义工具了。以后如果有时间在和大家谈一谈具体的应用。</p></span></p>
